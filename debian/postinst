#!/bin/sh -e

action="$1"
oldversion="$2"

. /usr/share/debconf/confmodule
db_version 2.0

umask 022

if [ "$action" != configure ] ; then
	exit 0
fi

# functions

setup_aprx_user() {
       if ! getent passwd aprx >/dev/null; then
                echo "Creating user account: 'aprx'"
                addgroup --quiet --system aprx
                adduser --quiet --system --no-create-home --ingroup aprx aprx
		adduser aprx dialout
        fi
}

fix_permissions() {
	touch /var/lib/aprx/RUN
	chown -R aprx:aprx /var/log/aprx /var/run/aprx /var/lib/aprx
}

apparmor_config() {
	# Reload AppArmor profile
	APP_PROFILE="/etc/apparmor.d/sbin.aprx"
	if [ -f "$APP_PROFILE" ] && aa-status --enabled 2>/dev/null; then
		echo "Installing apparmor profile..."
		apparmor_parser -r -T -W "$APP_PROFILE" || true
	fi
}

# main
setup_aprx_user
fix_permissions
apparmor_config

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

db_stop

exit 0
